import{b as se,a as te,r as p,j as e}from"./index-CuPLTIq6.js";import{L as W}from"./Layout-Bhj-hCGg.js";import{E as ae}from"./ExportModal-BX3XtV_d.js";import{A as re}from"./arrow-left-DI3Uksat.js";import{G as w}from"./gauge-C3G_6xek.js";import{D as ie}from"./download-BIeXtM7T.js";import{A as V}from"./activity-DvS__W_y.js";import{W as le}from"./wifi-off-C9qm20-S.js";import{A as _}from"./alert-triangle-CENt64Gl.js";import{T as f}from"./trending-up-KnywOmps.js";import{R as ne,A as ce,C as oe,X as de,Y as xe,T as me,a as pe}from"./AreaChart-DqSnVAAS.js";import{T as he,W as ge}from"./wind-BnPc78kP.js";import{D as z}from"./droplets-DPI-7e7N.js";import{B}from"./battery-wNEowIjo.js";import{M as fe}from"./map-pin-DeCLRHw5.js";import{E as ue}from"./eye-off-La60d6dM.js";import{E as je}from"./eye-DsZQJS_t.js";import"./x-BHP2hNWw.js";import"./createLucideIcon-Bp_Bh7vc.js";import"./calendar-BHWY2O9g.js";import"./file-spreadsheet-BNFMNFvj.js";import"./database-Cj7RBCxv.js";import"./string-9MY7XALd.js";const Ve=()=>{const{sectionId:x}=se(),S=te(),[t,y]=p.useState(null),[G,K]=p.useState(!0),[u,F]=p.useState(!1),[k,j]=p.useState([]),[Y,A]=p.useState(!1),[J,N]=p.useState([]);p.useEffect(()=>{const s=localStorage.getItem("observed_devices");if(s)try{const c=JSON.parse(s).map(i=>i.id);N(c)}catch(n){console.error("Error loading observed devices:",n)}},[]),p.useEffect(()=>{if(x){C();const s=setInterval(()=>{C()},1e4);return()=>clearInterval(s)}},[x]),p.useEffect(()=>{t!=null&&t.devices&&t.devices.length>0&&ee()},[t]);const C=async()=>{try{const s=await fetch(`/api/sections/${x}/devices`);if(s.ok){const n=await s.json();n.devices&&Array.isArray(n.devices)&&n.devices.sort((c,i)=>c.is_active!==i.is_active?i.is_active?1:-1:(c.client_id||"").localeCompare(i.client_id||"")),y(n)}else y({section_id:x||"I",section_name:`Section ${x}`,device_count:0,devices:[]})}catch(s){console.error("Error fetching section devices:",s),y({section_id:x||"I",section_name:`Section ${x}`,device_count:0,devices:[]})}finally{K(!1)}},U=s=>s?new Date(s).toLocaleString():"Never",v=s=>Math.random()>.7,X=(s,n)=>{var d,h,a,r;n.stopPropagation();const c=localStorage.getItem("observed_devices");let i=[];try{i=c?JSON.parse(c):[]}catch(l){console.error("Error parsing observed devices:",l),i=[]}if(i.some(l=>l.id===s.id))i=i.filter(l=>l.id!==s.id),N(l=>l.filter(o=>o!==s.id));else{const l={id:s.id,section_id:x,client_id:s.client_id,device_name:s.device_name,location:s.location,is_active:s.is_active,temperature:(d=s.latest_reading)==null?void 0:d.temperature,static_pressure:(h=s.latest_reading)==null?void 0:h.static_pressure,differential_pressure:(a=s.latest_reading)==null?void 0:a.differential_pressure,battery:(r=s.latest_reading)==null?void 0:r.battery};i.push(l),N(o=>[...o,s.id])}localStorage.setItem("observed_devices",JSON.stringify(i))},b=s=>J.includes(s),O=(t==null?void 0:t.devices.filter(s=>s.is_active).length)||0,q=((t==null?void 0:t.device_count)||0)-O,Q=(t==null?void 0:t.devices.filter(s=>v()).length)||0,Z=(t==null?void 0:t.devices.reduce((s,n)=>{var c;return s+(((c=n.latest_reading)==null?void 0:c.total_volume_flow)||0)},0))||0,E=u?(t==null?void 0:t.devices.filter(s=>v()))||[]:(t==null?void 0:t.devices)||[],ee=async()=>{if(!(t!=null&&t.devices)||t.devices.length===0){j([]);return}try{const n=t.devices.map(a=>a.id).map(a=>fetch(`/api/analytics/readings?device_id=${a}&page_size=200&page=1`).then(r=>r.ok?r.json():{data:[]}).then(r=>r.data||[]).catch(()=>[])),i=(await Promise.all(n)).flat();if(i.length===0){j([]);return}const m=new Map;i.forEach(a=>{const r=new Date(a.timestamp),l=`${a.device_id}-${r.getFullYear()}-${r.getMonth()}-${r.getDate()}-${r.getHours()}`;if(!m.has(l))m.set(l,a);else{const o=m.get(l);new Date(a.timestamp)>new Date(o.timestamp)&&m.set(l,a)}});const d=new Map;m.forEach(a=>{const r=new Date(a.timestamp),l=`${r.getFullYear()}-${r.getMonth()}-${r.getDate()}-${r.getHours()}`;d.has(l)||d.set(l,{time:r,totalFlow:0,deviceCount:0,deviceIds:new Set});const o=d.get(l);o.totalFlow+=a.total_volume_flow||0,o.deviceCount+=1,o.deviceIds.add(a.device_id)});const h=Array.from(d.values()).sort((a,r)=>a.time.getTime()-r.time.getTime()).slice(-24).map(a=>({time:a.time.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),flow:parseFloat(a.totalFlow.toFixed(2)),timestamp:a.time}));j(h)}catch(s){console.error("[SectionDetail] Error fetching flow history:",s),j([])}};return G?e.jsx(W,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"}),e.jsx("p",{className:"mt-4 text-gray-600 dark:text-gray-400",children:"Loading section data..."})]})}):e.jsxs(W,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"glass rounded-xl p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>S("/sections"),className:"p-2 hover:bg-gray-700/50 rounded-lg transition",children:e.jsx(re,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-white flex items-center gap-3",children:[e.jsx(w,{className:"w-8 h-8"}),t==null?void 0:t.section_name]}),e.jsxs("p",{className:"text-gray-400 mt-2",children:[(t==null?void 0:t.device_count)||0," SMS Devices"]})]})]}),e.jsxs("button",{onClick:()=>A(!0),className:"flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg hover:shadow-lg transition-all font-medium",children:[e.jsx(ie,{className:"w-5 h-5"}),e.jsx("span",{children:"Export Section Data"})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"bg-blue-100 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center",children:e.jsx(w,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:(t==null?void 0:t.device_count)||0}),e.jsx("div",{className:"text-xs text-gray-600",children:"Total Devices"})]})]})}),e.jsx("div",{className:"bg-green-100 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center",children:e.jsx(V,{className:"w-5 h-5 text-green-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:O}),e.jsx("div",{className:"text-xs text-gray-600",children:"Online"})]})]})}),e.jsx("div",{className:"bg-red-100 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-10 h-10 bg-red-500/20 rounded-lg flex items-center justify-center",children:e.jsx(le,{className:"w-5 h-5 text-red-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:q}),e.jsx("div",{className:"text-xs text-gray-600",children:"Offline"})]})]})}),e.jsx("div",{className:"bg-yellow-100 rounded-xl p-4 cursor-pointer hover:scale-105 transition-transform",onClick:()=>F(!u),children:e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-10 h-10 bg-yellow-500/20 rounded-lg flex items-center justify-center",children:e.jsx(_,{className:"w-5 h-5 text-yellow-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:Q}),e.jsx("div",{className:"text-xs text-gray-600",children:u?"Showing Alarms":"With Alarms"})]})]})})]}),e.jsx("div",{className:"glass rounded-xl p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-cyan-500/20 rounded-xl flex items-center justify-center",children:e.jsx(f,{className:"w-6 h-6 text-cyan-400"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400",children:"Total Volume Flow"}),e.jsx("div",{className:"text-4xl font-bold text-cyan-400",children:Z.toFixed(2)}),e.jsx("div",{className:"text-sm text-gray-400",children:"MCF/day"})]})]})}),e.jsxs("div",{className:"glass rounded-xl p-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h3",{className:"text-xl font-semibold text-white flex items-center gap-2",children:[e.jsx(f,{className:"w-5 h-5 text-cyan-400"}),"Section Total Volume Flow (Last 24 Hours)"]}),e.jsxs("p",{className:"text-sm text-gray-400 mt-1",children:["Sum of all device flows in ",t==null?void 0:t.section_name]})]}),e.jsx("div",{style:{height:"300px"},children:k.length>0?e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(ce,{data:k,margin:{top:10,right:30,left:0,bottom:0},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"colorFlow",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#22d3ee",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"#22d3ee",stopOpacity:.1})]})}),e.jsx(oe,{strokeDasharray:"3 3",stroke:"#374151",opacity:.3}),e.jsx(de,{dataKey:"time",stroke:"#9ca3af",style:{fontSize:"12px"},interval:"preserveStartEnd"}),e.jsx(xe,{stroke:"#9ca3af",style:{fontSize:"12px"},label:{value:"Flow (MCF/day)",angle:-90,position:"insideLeft",fill:"#9ca3af",fontSize:12}}),e.jsx(me,{contentStyle:{backgroundColor:"#1e293b",border:"1px solid #334155",borderRadius:"8px",color:"#fff"},formatter:s=>[s.toFixed(2)+" MCF/day","Total Flow"],labelFormatter:s=>`Time: ${s}`}),e.jsx(pe,{type:"monotone",dataKey:"flow",stroke:"#22d3ee",strokeWidth:2,fillOpacity:1,fill:"url(#colorFlow)"})]})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx(f,{className:"w-12 h-12 mx-auto mb-3 text-gray-500"}),e.jsx("p",{className:"text-gray-400",children:"Collecting flow data..."})]})})})]}),e.jsx("div",{className:"glass rounded-xl overflow-hidden",children:e.jsx("div",{className:"overflow-auto",style:{maxHeight:"calc(100vh - 600px)",minHeight:"400px"},children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{className:"bg-gray-100 border-b border-gray-300 sticky top-0 z-10",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"#"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Device"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(he,{className:"w-3 h-3"}),"Temp (Â°F)"]})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(w,{className:"w-3 h-3"}),"Static P (PSI)"]})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(f,{className:"w-3 h-3 text-red-600"}),"Max P (PSI)"]})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(f,{className:"w-3 h-3 text-green-600 transform rotate-180"}),"Min P (PSI)"]})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ge,{className:"w-3 h-3"}),"Diff P (IWC)"]})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"w-3 h-3"}),"Volume (MCF)"]})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"w-3 h-3 text-purple-600"}),"Volume (MMCF)"]})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(f,{className:"w-3 h-3"}),"Flow (MCF/d)"]})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(B,{className:"w-3 h-3"}),"Battery"]})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Last Reading"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Alarms"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:E.map((s,n)=>{var d,h,a,r,l,o,M,T,$,I,D,P,H,L,R;const c=v(),i=((d=s.latest_reading)==null?void 0:d.battery)||0,m=g=>g===0?"text-gray-500":g<10?"text-red-600":g<10.5?"text-red-400":g<=14?"text-green-400":"text-yellow-400";return e.jsxs("tr",{onClick:()=>S(`/stations/${s.id}`),className:"hover:bg-gray-100 cursor-pointer transition-colors",children:[e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"text-sm font-medium text-gray-700",children:n+1})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.device_name||s.client_id}),e.jsx("div",{className:"text-xs text-gray-600",children:s.client_id}),s.location&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-600 mt-1",children:[e.jsx(fe,{className:"w-3 h-3"}),s.location]})]})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${s.is_active?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:[e.jsx(V,{className:"w-3 h-3"}),s.is_active?"Online":"Offline"]})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"text-sm text-gray-900",children:((a=(h=s.latest_reading)==null?void 0:h.temperature)==null?void 0:a.toFixed(1))||"-"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"text-sm text-gray-900",children:((l=(r=s.latest_reading)==null?void 0:r.static_pressure)==null?void 0:l.toFixed(1))||"-"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"text-sm font-medium text-red-600",children:((o=s.latest_reading)==null?void 0:o.max_static_pressure)!=null?s.latest_reading.max_static_pressure.toFixed(1):"-"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"text-sm font-medium text-green-600",children:((M=s.latest_reading)==null?void 0:M.min_static_pressure)!=null?s.latest_reading.min_static_pressure.toFixed(1):"-"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"text-sm text-gray-900",children:(($=(T=s.latest_reading)==null?void 0:T.differential_pressure)==null?void 0:$.toFixed(1))||"-"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"text-sm text-gray-900",children:((D=(I=s.latest_reading)==null?void 0:I.volume)==null?void 0:D.toFixed(1))||"-"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"text-sm font-medium text-purple-600",children:(P=s.latest_reading)!=null&&P.volume?(s.latest_reading.volume/1e3).toFixed(3):"-"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"text-sm font-medium text-cyan-700",children:((L=(H=s.latest_reading)==null?void 0:H.total_volume_flow)==null?void 0:L.toFixed(1))||"-"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:`w-4 h-4 ${m(i)}`}),e.jsx("span",{className:`text-sm font-medium ${m(i)}`,children:i>0?`${i.toFixed(2)}V`:"-"})]})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("div",{className:"text-xs text-gray-600",children:(R=s.latest_reading)!=null&&R.timestamp?U(s.latest_reading.timestamp):"No data"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:c?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700",children:[e.jsx(_,{className:"w-3 h-3"}),"Active"]}):e.jsx("span",{className:"text-xs text-gray-600",children:"None"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-center",children:e.jsx("button",{onClick:g=>X(s,g),className:`inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${b(s.id)?"bg-blue-100 text-blue-700 hover:bg-blue-200":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,title:b(s.id)?"Remove from observation":"Add to observation",children:b(s.id)?e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Observing"})]}):e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Observe"})]})})})]},s.id)})})]})})}),E.length===0&&e.jsx("div",{className:"glass rounded-xl p-12 text-center",children:u?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-16 h-16 mx-auto mb-4 text-yellow-400"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"No Active Alarms"}),e.jsx("p",{className:"text-gray-400",children:"All devices in this section are operating normally."}),e.jsx("button",{onClick:()=>F(!1),className:"mt-4 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:"Show All Devices"})]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"No devices found"}),e.jsx("p",{className:"text-gray-400",children:"This section doesn't have any SMS devices yet."})]})})]}),e.jsx(ae,{isOpen:Y,onClose:()=>A(!1),sectionId:x,exportType:"section"})]})};export{Ve as default};
