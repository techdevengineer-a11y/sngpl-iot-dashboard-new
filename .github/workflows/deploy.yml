name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy Application
        run: |
          echo "üöÄ Starting deployment..."

          # Backend deployment
          echo "üì¶ Deploying backend..."

          # Backup .env file
          if [ -f /var/www/sngpl-dashboard/backend/app/.env ]; then
            cp /var/www/sngpl-dashboard/backend/app/.env /tmp/backend-env.backup
            echo "‚úÖ Backed up .env file"
          fi

          # Copy new backend files (preserve venv and .env)
          sudo rsync -av --exclude='venv' --exclude='__pycache__' --exclude='*.pyc' --exclude='.env' $GITHUB_WORKSPACE/sngpl-backend/ /var/www/sngpl-dashboard/backend/

          # Restore .env file
          if [ -f /tmp/backend-env.backup ]; then
            sudo cp /tmp/backend-env.backup /var/www/sngpl-dashboard/backend/app/.env
            sudo chown ubuntu:ubuntu /var/www/sngpl-dashboard/backend/app/.env
            echo "‚úÖ Restored .env file"
          fi

          # Install Python dependencies
          cd /var/www/sngpl-dashboard/backend
          source venv/bin/activate
          pip install -r requirements.txt --quiet
          echo "‚úÖ Python dependencies installed"

          # Restart backend services
          sudo systemctl restart sngpl-backend
          sudo systemctl restart mqtt-listener 2>/dev/null || echo "‚ö†Ô∏è mqtt-listener service not found"
          echo "‚úÖ Backend services restarted"

          # Frontend deployment
          echo "üì¶ Deploying frontend..."

          # Copy new frontend files
          sudo rsync -av --exclude='node_modules' --exclude='dist' $GITHUB_WORKSPACE/sngpl-frontend/ /var/www/sngpl-dashboard/frontend/

          # Install dependencies and build
          cd /var/www/sngpl-dashboard/frontend
          npm install --silent --legacy-peer-deps
          npm run build
          echo "‚úÖ Frontend built successfully"

          # Copy build to web root
          sudo rm -rf /var/www/html/*
          sudo cp -r dist/* /var/www/html/

          # Set permissions
          sudo chown -R ubuntu:ubuntu /var/www/sngpl-dashboard
          sudo chown -R www-data:www-data /var/www/html

          # Reload nginx
          sudo nginx -t && sudo systemctl reload nginx
          echo "‚úÖ Nginx reloaded"

          # Cleanup
          rm -f /tmp/backend-env.backup

          echo "üéâ Deployment complete!"

      - name: Deployment Status
        if: success()
        run: echo "‚úÖ Successfully deployed to EC2 server!"

      - name: Deployment Failed
        if: failure()
        run: echo "‚ùå Deployment failed! Check the logs above."
