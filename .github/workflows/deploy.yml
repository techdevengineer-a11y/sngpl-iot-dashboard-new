name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy Backend to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "sngpl-backend/*"
          target: "/tmp/deploy-backend/"
          strip_components: 1

      - name: Deploy Frontend to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "sngpl-frontend/*"
          target: "/tmp/deploy-frontend/"
          strip_components: 1

      - name: Install and Restart Services
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üöÄ Starting deployment..."

            # Backend deployment
            echo "üì¶ Deploying backend..."

            # Backup .env file
            if [ -f /var/www/sngpl-dashboard/backend/app/.env ]; then
              cp /var/www/sngpl-dashboard/backend/app/.env /tmp/backend-env.backup
              echo "‚úÖ Backed up .env file"
            fi

            # Copy new backend files (preserve venv and .env)
            sudo rsync -av --exclude='venv' --exclude='__pycache__' --exclude='*.pyc' --exclude='.env' /tmp/deploy-backend/ /var/www/sngpl-dashboard/backend/

            # Restore .env file
            if [ -f /tmp/backend-env.backup ]; then
              sudo cp /tmp/backend-env.backup /var/www/sngpl-dashboard/backend/app/.env
              sudo chown ubuntu:ubuntu /var/www/sngpl-dashboard/backend/app/.env
              echo "‚úÖ Restored .env file"
            fi

            # Install Python dependencies
            cd /var/www/sngpl-dashboard/backend
            source venv/bin/activate
            pip install -r requirements.txt --quiet
            echo "‚úÖ Python dependencies installed"

            # Restart backend services
            sudo systemctl restart sngpl-backend
            sudo systemctl restart mqtt-listener 2>/dev/null || echo "‚ö†Ô∏è mqtt-listener service not found"
            echo "‚úÖ Backend services restarted"

            # Frontend deployment
            echo "üì¶ Deploying frontend..."

            # Copy new frontend files
            sudo rsync -av --exclude='node_modules' --exclude='dist' /tmp/deploy-frontend/ /var/www/sngpl-dashboard/frontend/

            # Install dependencies and build
            cd /var/www/sngpl-dashboard/frontend
            npm install --silent
            npm run build
            echo "‚úÖ Frontend built successfully"

            # Copy build to web root
            sudo rm -rf /var/www/html/*
            sudo cp -r dist/* /var/www/html/

            # Set permissions
            sudo chown -R ubuntu:ubuntu /var/www/sngpl-dashboard
            sudo chown -R www-data:www-data /var/www/html

            # Reload nginx
            sudo nginx -t && sudo systemctl reload nginx
            echo "‚úÖ Nginx reloaded"

            # Cleanup temp files
            rm -rf /tmp/deploy-backend /tmp/deploy-frontend /tmp/backend-env.backup

            echo "üéâ Deployment complete!"

      - name: Deployment Status
        if: success()
        run: echo "‚úÖ Successfully deployed to EC2 server!"

      - name: Deployment Failed
        if: failure()
        run: echo "‚ùå Deployment failed! Check the logs above."
